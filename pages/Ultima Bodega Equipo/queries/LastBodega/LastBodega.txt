WITH CTE AS (
    SELECT ts,TagID, BodegaID, ROW_NUMBER() OVER (PARTITION BY TagID ORDER BY ts DESC) AS posicion
    FROM contraincendiosh.REGISTROS_GATEWAYS_LOGS
)
SELECT 
	CTE.ts,
	R.NombreRecurso,
	B.NombreBodega,
	CTE.TagID
FROM CTE
	LEFT JOIN contraincendiosh.TAGS_HYDRATION TH ON CTE.TagID = TH.TagID
	LEFT JOIN contraincendiosh.RECURSOS R ON R.RecursoID = TH.RecursoID
	LEFT JOIN contraincendiosh.BODEGAS B ON CTE.BodegaID = B.BodegaID
WHERE posicion = 1
ORDER BY ts DESC